<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Organization Chart</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=DM+Sans:wght@300;400;500&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: #f7f5f0;
    padding: 40px 20px;
    min-height: 100vh;
  }

  .chart-title {
    text-align: center;
    font-family: 'Playfair Display', serif;
    font-size: 14px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: #8a7e6e;
    margin-bottom: 40px;
  }

  .tree {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0;
  }

  .node-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .node {
    background: #fff;
    border-radius: 12px;
    padding: 16px 20px;
    min-width: 200px;
    max-width: 240px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    position: relative;
  }

  .node.visionary  { border-top: 4px solid #c9a96e; min-width: 240px; }
  .node.integrator { border-top: 4px solid #7a9e87; min-width: 220px; }
  .node.department { border-top: 4px solid #7a8ea8; min-width: 180px; }

  .node-label {
    font-family: 'Playfair Display', serif;
    font-size: 15px;
    color: #2c2c2c;
    margin-bottom: 10px;
    text-align: center;
    min-height: 22px;
  }

  .roles-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .role-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .role-input {
    width: 100%;
    border: none;
    border-bottom: 1px dashed #d0c8bc;
    background: transparent;
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    color: #555;
    padding: 2px 4px;
    outline: none;
    transition: border-color 0.2s;
  }

  .role-input:focus { border-bottom-color: #c9a96e; color: #222; }
  .role-input::placeholder { color: #bbb; font-style: italic; }

  .add-role-btn {
    display: block;
    width: 100%;
    margin-top: 8px;
    background: none;
    border: 1px dashed #d0c8bc;
    border-radius: 6px;
    padding: 4px;
    font-size: 11px;
    color: #aaa;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
  }

  .add-role-btn:hover {
    border-color: #c9a96e;
    color: #c9a96e;
    background: #fdf9f3;
  }

  .connector-v { width: 2px; height: 28px; background: #d5cfc6; }

  .dept-columns {
    display: flex;
    gap: 20px;
    align-items: flex-start;
    position: relative;
  }

  .dept-col {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .dept-row-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .del-btn {
    background: none;
    border: none;
    color: #ccc;
    cursor: pointer;
    font-size: 13px;
    line-height: 1;
    padding: 0 2px;
    transition: color 0.15s;
    flex-shrink: 0;
  }
  .del-btn:hover { color: #e07070; }

  #status {
    position: fixed;
    bottom: 16px;
    right: 16px;
    font-size: 11px;
    font-family: 'DM Sans', sans-serif;
    padding: 6px 14px;
    border-radius: 20px;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    color: #fff;
  }
  #status.show { opacity: 1; }
  #status.saving { background: #c9a96e; }
  #status.saved  { background: #7a9e87; }
  #status.error  { background: #c97a7a; }

  #loading {
    position: fixed;
    inset: 0;
    background: #f7f5f0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    z-index: 100;
    transition: opacity 0.4s;
  }
  #loading.hidden { opacity: 0; pointer-events: none; }
  .spinner {
    width: 28px; height: 28px;
    border: 3px solid #d5cfc6;
    border-top-color: #c9a96e;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loading p { font-size: 12px; color: #8a7e6e; letter-spacing: 0.1em; }
</style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <p>Loading chart…</p>
</div>

<p class="chart-title">Organizational Structure</p>

<div class="tree" id="tree">

  <div class="node-wrap">
    <div class="node visionary">
      <div class="node-label" id="label-visionary">Visionary</div>
      <ul class="roles-list" id="roles-visionary"></ul>
      <button class="add-role-btn" onclick="addRole('visionary')">+ Add Role</button>
    </div>
  </div>

  <div class="connector-v"></div>

  <div class="node-wrap">
    <div class="node integrator">
      <div class="node-label" id="label-integrator">Integrator</div>
      <ul class="roles-list" id="roles-integrator"></ul>
      <button class="add-role-btn" onclick="addRole('integrator')">+ Add Role</button>
    </div>
  </div>

  <div class="connector-v"></div>

  <div class="dept-row-wrap">
    <div id="h-bar" style="height:2px;background:#d5cfc6;"></div>
    <div class="dept-columns" id="dept-columns"></div>
  </div>

</div>

<div id="status"></div>

<script>
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzvRtMni8jaJCSA1JOY5zzMAMVM762fwMwWKJ-jxt51vARov_6VKSrOikYa2NpZo6zdPQ/exec';

  const depts = [
    { id: 'sales',   label: 'Sales / Marketing' },
    { id: 'ops',     label: 'Operations / Product' },
    { id: 'finance', label: 'Finance' },
    { id: 'hr',      label: 'HR' },
  ];

  const deptColors = {
    sales: '#c9a96e', ops: '#7a9e87', finance: '#7a8ea8', hr: '#a87a8e',
  };

  const defaultLabels = {
    visionary:  'Visionary',
    integrator: 'Integrator',
    sales:      'Sales / Marketing',
    ops:        'Operations / Product',
    finance:    'Finance',
    hr:         'HR',
  };

  const defaultRoles = {
    visionary:  ['Chief Executive Officer', 'Chief Strategy Officer'],
    integrator: ['Chief Operating Officer'],
    sales:      ['Sales Director', 'Marketing Manager'],
    ops:        ['Product Manager', 'Operations Lead'],
    finance:    ['CFO', 'Financial Analyst'],
    hr:         ['HR Director', 'Recruiter'],
  };

  const deptColumns = document.getElementById('dept-columns');
  const hBar        = document.getElementById('h-bar');
  const statusEl    = document.getElementById('status');
  const loadingEl   = document.getElementById('loading');
  let saveTimer     = null;

  // Build dept shells
  depts.forEach(dept => {
    const col = document.createElement('div');
    col.className = 'dept-col';
    col.id = 'col-' + dept.id;
    col.innerHTML = `
      <div class="connector-v"></div>
      <div class="node department" id="node-${dept.id}" style="border-top-color:${deptColors[dept.id]}">
        <div class="node-label" id="label-${dept.id}">${dept.label}</div>
        <ul class="roles-list" id="roles-${dept.id}"></ul>
        <button class="add-role-btn" onclick="addRole('${dept.id}')">+ Add Role</button>
      </div>
    `;
    deptColumns.appendChild(col);
  });

  // Status
  function showStatus(msg, type, duration = 2000) {
    statusEl.textContent = msg;
    statusEl.className = `show ${type}`;
    clearTimeout(statusEl._t);
    if (duration) statusEl._t = setTimeout(() => statusEl.className = '', duration);
  }

  // Apply labels from sheet to heading elements
  function applyLabels(labels) {
    const allIds = ['visionary', 'integrator', ...depts.map(d => d.id)];
    allIds.forEach(id => {
      const el = document.getElementById('label-' + id);
      if (el && labels && labels[id]) {
        el.textContent = labels[id];
      }
    });
  }

  // Add role row
  function addRole(sectionId, value = '', andSave = true) {
    const list = document.getElementById('roles-' + sectionId);
    if (!list) return;
    const li = document.createElement('li');
    li.className = 'role-item';

    const input = document.createElement('input');
    input.className   = 'role-input';
    input.type        = 'text';
    input.value       = value;
    input.placeholder = 'Enter role…';
    input.addEventListener('input', scheduleSave);
    input.addEventListener('blur',  scheduleSave);

    const del = document.createElement('button');
    del.className   = 'del-btn';
    del.title       = 'Remove';
    del.textContent = '×';
    del.addEventListener('click', () => { li.remove(); scheduleSave(); });

    li.appendChild(input);
    li.appendChild(del);
    list.appendChild(li);

    if (andSave) scheduleSave();
  }

  // Debounced save
  function scheduleSave() {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(saveData, 900);
  }

  function getAllRows() {
    const sections = ['visionary', 'integrator', ...depts.map(d => d.id)];
    const rows = [];
    sections.forEach(id => {
      document.querySelectorAll(`#roles-${id} .role-input`).forEach(inp => {
        const v = inp.value.trim();
        if (v) rows.push({ section: id, role: v });
      });
    });
    return rows;
  }

  async function saveData() {
    showStatus('Saving…', 'saving', 0);
    try {
      await fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'save', data: getAllRows() }),
      });
      showStatus('✓ Saved', 'saved', 2000);
    } catch (e) {
      showStatus('⚠ Save failed', 'error', 3000);
    }
  }

  async function loadData() {
    try {
      const res  = await fetch(SCRIPT_URL + '?t=' + Date.now());
      const json = await res.json();

      // Apply labels from Labels sheet
      if (json.labels) applyLabels(json.labels);

      const rows = json.rows || [];
      if (rows.length === 0) {
        // First time — seed defaults
        Object.entries(defaultRoles).forEach(([id, roles]) =>
          roles.forEach(r => addRole(id, r, false))
        );
        saveData();
      } else {
        rows.forEach(({ section, role }) => {
          if (document.getElementById('roles-' + section)) {
            addRole(section, role, false);
          }
        });
      }
    } catch (e) {
      // Fallback to defaults
      applyLabels(defaultLabels);
      Object.entries(defaultRoles).forEach(([id, roles]) =>
        roles.forEach(r => addRole(id, r, false))
      );
      showStatus('⚠ Could not load data', 'error', 4000);
    }

    loadingEl.classList.add('hidden');
    setTimeout(updateHBar, 100);
  }

  function updateHBar() {
    const cols = document.querySelectorAll('.dept-col');
    if (cols.length < 2) return;
    const first  = cols[0].getBoundingClientRect();
    const last   = cols[cols.length - 1].getBoundingClientRect();
    const parent = deptColumns.getBoundingClientRect();
    const left   = first.left + first.width  / 2 - parent.left;
    const right  = last.left  + last.width   / 2 - parent.left;
    hBar.style.width      = (right - left) + 'px';
    hBar.style.marginLeft = left + 'px';
  }

  window.addEventListener('resize', updateHBar);
  loadData();
</script>
</body>
</html>
